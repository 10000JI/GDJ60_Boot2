<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
 <mapper namespace="com.iu.base.member.MemberDAO">
	<insert id="setJoin" parameterType="MemberVO" >
		INSERT INTO MEMBER
		VALUES (#{userName},#{passWord},#{name},#{email},#{birth},#{enabled})
	</insert>
	
	<insert id="setMemberRole" parameterType="Map">
		INSERT INTO MEMBER_ROLE (USERNAME, NUM)
		VALUES (#{userName}, #{num})
	</insert>
	
	<select id="getLogin" parameterType="MemberVO" resultMap="getLoginResult" >
		SELECT M.userName, M.email, R.num, R.roleName
		FROM MEMBER M
			INNER JOIN 
 			MEMBER_ROLE MR
 			ON (M.USERNAME = MR.USERNAME)
 			INNER JOIN
 			ROLE R 
 			ON (MR.NUM = R.NUM)
		WHERE M.USERNAME=#{userName} AND M.PASSWORD=#{passWord}
	</select>
	
	<resultMap type="MemberVO" id="getLoginResult">
		<id column="userName" property="userName" />
		<result column="eamil" property="email"/>
		<collection property="roleVOs" javaType="List" ofType="RoleVO">
			<id column="num" property="num"/>
			<result column="ROLENAME" property="roleName"/>
		</collection>	
	</resultMap>
	
	<select id="getList" resultType="MemberVO">
		SELECT * FROM MEMBER
	</select>
	
	<select id="getUserList" resultType="MemberVO">
		SELECT USERNAME FROM MEMBER
	</select>
	
	<select id="idDuplicateCheck" resultType="MemberVO" parameterType="MemberVO">
		SELECT USERNAME FROM MEMBER WHERE USERNAME=#{userName}
	</select>
	
	<update id="setLastTimeUpdate" parameterType="MemberVO" >
	UPDATE MEMBER SET LASTTIME=now()  WHERE USERNAME=#{userName}
 	</update>
 	
 	<update id="setEnabledUpdate">
 	<!-- <![CDATA[  
 		UPDATE MEMBER SET ENABLED = 0
		WHERE LASTTIME <= now()-INTERVAL 3 DAY
	]]>  -->
	UPDATE MEMBER SET ENABLED = 0
	WHERE USERNAME 
		IN 
			(
				SELECT userName FROM MEMBER 
				WHERE TIMESTAMPDIFF(DAY,LASTTIME,now()
			)
		>=3
	)
 	</update>
 	
 	<select id="getBirthList" resultType="MemberVO">
 	SELECT * FROM MEMBER
	WHERE DATE_FORMAT(birth,'%M-%D')=DATE_FORMAT(now(),'%M-%D')  
 	</select>
 </mapper>